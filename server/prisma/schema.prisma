generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String            @id @default(uuid())
  email            String            @unique
  passwordHash     String            @map("password_hash")
  fullName         String            @map("full_name")
  isActive         Boolean           @default(true) @map("is_active")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  roleId           String            @map("role_id")
  purchaseOrders   PurchaseOrder[]
  purchaseReturns  PurchaseReturn[]
  salesReturns     SalesReturn[]
  stockAdjustments StockAdjustment[]
  transactions     Transaction[]
  role             Role              @relation(fields: [roleId], references: [id])

  @@map("users")
}

model RolePermission {
  id        String   @id @default(uuid())
  menuPath  String   @map("menu_path")
  menuLabel String   @map("menu_label")
  canRead   Boolean  @default(true) @map("can_read")
  canCreate Boolean  @default(false) @map("can_create")
  canUpdate Boolean  @default(false) @map("can_update")
  canDelete Boolean  @default(false) @map("can_delete")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  roleId    String   @map("role_id")
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, menuPath])
  @@map("role_permissions")
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique @map("name")
  displayName String           @map("display_name")
  description String?
  isActive    Boolean          @default(true) @map("is_active")
  isSystem    Boolean          @default(false) @map("is_system")
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  permissions RolePermission[]
  users       User[]

  @@map("roles")
}

model Supplier {
  id              String           @id @default(uuid())
  name            String
  contactPerson   String?          @map("contact_person")
  phone           String?
  email           String?
  address         String?
  isActive        Boolean          @default(true) @map("is_active")
  createdAt       DateTime         @default(now()) @map("created_at")
  products        Product[]
  purchaseOrders  PurchaseOrder[]
  purchaseReturns PurchaseReturn[]

  @@map("suppliers")
}

model Category {
  id          Int        @id @default(autoincrement())
  name        String
  slug        String     @unique
  description String?
  createdAt   DateTime   @default(now()) @map("created_at")
  discounts   Discount[]
  products    Product[]

  @@map("categories")
}

model Unit {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  label     String
  qty       Int      @default(1)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("units")
}

model Product {
  id                 String               @id @default(uuid())
  sku                String               @unique
  name               String
  description        String?
  price              Decimal              @db.Decimal(12, 2)
  costPrice          Decimal              @map("cost_price") @db.Decimal(12, 2)
  stockQuantity      Int                  @map("stock_quantity")
  lowStockThreshold  Int                  @map("low_stock_threshold")
  categoryId         Int                  @map("category_id")
  supplierId         String?              @map("supplier_id")
  barcode            String?              @unique
  imageUrl           String?              @map("image_url")
  isActive           Boolean              @default(true) @map("is_active")
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")
  baseUnit           String               @default("pcs") @map("base_unit")
  pricePerUnit       Json?                @map("price_per_unit")
  purchaseUnit       String               @default("pcs") @map("purchase_unit")
  purchaseUnitQty    Int                  @default(1) @map("purchase_unit_qty")
  saleUnits          String[]             @default(["pcs"]) @map("sale_units")
  batchNumber        String?              @map("batch_number")
  expiryAlertDays    Int?                 @default(30) @map("expiry_alert_days")
  expiryDate         DateTime?            @map("expiry_date")
  manufactureDate    DateTime?            @map("manufacture_date")
  isReturnable       Boolean              @default(true) @map("is_returnable")
  category           Category             @relation(fields: [categoryId], references: [id])
  supplier           Supplier?            @relation(fields: [supplierId], references: [id])
  purchaseOrderItems PurchaseOrderItem[]
  PurchaseReturnItem PurchaseReturnItem[]
  SalesReturnItem    SalesReturnItem[]
  stockAdjustments   StockAdjustment[]
  transactionItems   TransactionItem[]

  @@map("products")
}

model Transaction {
  id              String            @id @default(uuid())
  invoiceNumber   String            @unique @map("invoice_number")
  userId          String            @map("user_id")
  customerName    String?           @map("customer_name")
  subtotal        Decimal           @db.Decimal(12, 2)
  taxAmount       Decimal           @map("tax_amount") @db.Decimal(12, 2)
  discountAmount  Decimal           @map("discount_amount") @db.Decimal(12, 2)
  totalAmount     Decimal           @map("total_amount") @db.Decimal(12, 2)
  paidAmount      Decimal?          @map("paid_amount") @db.Decimal(12, 2)
  changeAmount    Decimal?          @map("change_amount") @db.Decimal(12, 2)
  paymentMethod   PaymentMethod     @map("payment_method")
  status          TransactionStatus
  paymentStatus   PaymentStatus     @default(PAID) @map("payment_status")
  remainingAmount Decimal           @default(0) @map("remaining_amount") @db.Decimal(12, 2)
  dueDate         DateTime?         @map("due_date")
  customerId      String?           @map("customer_id")
  transactionDate DateTime          @default(now()) @map("transaction_date")
  discountId      String?           @map("discount_id")
  payment         Payment?
  salesReturns    SalesReturn[]
  items           TransactionItem[]
  debtPayments    DebtPayment[]
  user            User              @relation(fields: [userId], references: [id])
  customer        Customer?         @relation(fields: [customerId], references: [id])

  @@map("transactions")
}

model Customer {
  id            String        @id @default(uuid())
  code          String        @unique // Member Code e.g., CUST-001
  name          String
  phone         String?
  email         String?
  address       String?
  creditLimit   Decimal?      @map("credit_limit") @db.Decimal(12, 2)
  currentDebt   Decimal       @default(0) @map("current_debt") @db.Decimal(12, 2)
  isActive      Boolean       @default(true) @map("is_active")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  transactions  Transaction[]

  @@map("customers")
}

model DebtPayment {
  id            String        @id @default(uuid())
  transactionId String        @map("transaction_id")
  amount        Decimal       @db.Decimal(12, 2)
  paymentDate   DateTime      @default(now()) @map("payment_date")
  paymentMethod PaymentMethod
  notes         String?
  transaction   Transaction   @relation(fields: [transactionId], references: [id])

  @@map("debt_payments")
}

model Payment {
  id              String      @id @default(uuid())
  transactionId   String      @unique @map("transaction_id")
  orderId         String      @unique @map("order_id")
  amount          Decimal     @db.Decimal(12, 2)
  paymentType     String      @map("payment_type")
  status          String      @default("pending")
  qrCode          String?     @map("qr_code")
  expiryTime      DateTime?   @map("expiry_time")
  paidAt          DateTime?   @map("paid_at")
  gatewayResponse Json?       @map("gateway_response")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  transaction     Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model TransactionItem {
  id             String      @id @default(uuid())
  transactionId  String      @map("transaction_id")
  productId      String      @map("product_id")
  quantity       Int
  unitPrice      Decimal     @map("unit_price") @db.Decimal(12, 2)
  totalPrice     Decimal     @map("total_price") @db.Decimal(12, 2)
  discountAmount Decimal?    @map("discount_amount") @db.Decimal(12, 2)
  discountId     String?     @map("discount_id")
  product        Product     @relation(fields: [productId], references: [id])
  transaction    Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("transaction_items")
}

model StockAdjustment {
  id                 String   @id @default(uuid())
  productId          String   @map("product_id")
  previousQuantity   Int      @map("previous_quantity")
  newQuantity        Int      @map("new_quantity")
  adjustmentQuantity Int      @map("adjustment_quantity")
  reason             String
  userId             String   @map("user_id")
  createdAt          DateTime @default(now()) @map("created_at")
  product            Product  @relation(fields: [productId], references: [id])
  user               User     @relation(fields: [userId], references: [id])

  @@map("stock_adjustments")
}

model PurchaseOrder {
  id             Int                 @id @default(autoincrement())
  poNumber       String              @unique @map("po_number")
  supplierId     String              @map("supplier_id")
  totalAmount    Decimal             @map("total_amount") @db.Decimal(10, 2)
  status         PurchaseStatus      @default(PENDING)
  receivedAt     DateTime?           @map("received_at")
  notes          String?
  createdBy      String              @map("created_by")
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")
  items          PurchaseOrderItem[]
  user           User                @relation(fields: [createdBy], references: [id])
  supplier       Supplier            @relation(fields: [supplierId], references: [id])
  PurchaseReturn PurchaseReturn[]

  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              Int           @id @default(autoincrement())
  purchaseOrderId Int           @map("purchase_order_id")
  productId       String        @map("product_id")
  quantity        Int
  unitPrice       Decimal       @map("unit_price") @db.Decimal(10, 2)
  totalPrice      Decimal       @map("total_price") @db.Decimal(10, 2)
  product         Product       @relation(fields: [productId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@map("purchase_order_items")
}

model Discount {
  id                 String       @id @default(uuid())
  code               String       @unique
  name               String
  description        String?
  type               DiscountType
  value              Decimal      @db.Decimal(12, 2)
  minPurchase        Decimal?     @map("min_purchase") @db.Decimal(12, 2)
  startDate          DateTime?    @map("start_date")
  endDate            DateTime?    @map("end_date")
  isActive           Boolean      @default(true) @map("is_active")
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")
  applicableProducts String[]     @default([]) @map("applicable_products")
  categoryId         Int?         @map("category_id")
  category           Category?    @relation(fields: [categoryId], references: [id])
  applicableUnit     String?      @map("applicable_unit")

  @@map("discounts")
}

model SalesReturn {
  id            String            @id @default(uuid())
  returnNumber  String            @unique @map("return_number")
  transactionId String            @map("transaction_id")
  returnDate    DateTime          @default(now()) @map("return_date")
  reason        String
  notes         String?
  refundAmount  Decimal           @map("refund_amount") @db.Decimal(12, 2)
  refundMethod  RefundMethod      @map("refund_method")
  status        ReturnStatus      @default(APPROVED)
  userId        String            @map("user_id")
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")
  items         SalesReturnItem[]
  transaction   Transaction       @relation(fields: [transactionId], references: [id])
  user          User              @relation(fields: [userId], references: [id])

  @@map("sales_returns")
}

model SalesReturnItem {
  id            String        @id @default(uuid())
  salesReturnId String        @map("sales_return_id")
  productId     String        @map("product_id")
  quantity      Int
  unitPrice     Decimal       @map("unit_price") @db.Decimal(12, 2)
  subtotal      Decimal       @db.Decimal(12, 2)
  reason        String?
  condition     ItemCondition
  product       Product       @relation(fields: [productId], references: [id])
  salesReturn   SalesReturn   @relation(fields: [salesReturnId], references: [id], onDelete: Cascade)

  @@map("sales_return_items")
}

model PurchaseReturn {
  id              String               @id @default(uuid())
  returnNumber    String               @unique @map("return_number")
  purchaseOrderId Int                  @map("purchase_order_id")
  supplierId      String               @map("supplier_id")
  returnDate      DateTime             @default(now()) @map("return_date")
  reason          String
  notes           String?
  returnAmount    Decimal              @map("return_amount") @db.Decimal(12, 2)
  refundReceived  Boolean              @default(false) @map("refund_received")
  refundDate      DateTime?            @map("refund_date")
  userId          String               @map("user_id")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
  items           PurchaseReturnItem[]
  purchaseOrder   PurchaseOrder        @relation(fields: [purchaseOrderId], references: [id])
  supplier        Supplier             @relation(fields: [supplierId], references: [id])
  user            User                 @relation(fields: [userId], references: [id])

  @@map("purchase_returns")
}

model PurchaseReturnItem {
  id               String         @id @default(uuid())
  purchaseReturnId String         @map("purchase_return_id")
  productId        String         @map("product_id")
  quantity         Int
  unitPrice        Decimal        @map("unit_price") @db.Decimal(12, 2)
  subtotal         Decimal        @db.Decimal(12, 2)
  reason           String?
  condition        ItemCondition
  product          Product        @relation(fields: [productId], references: [id])
  purchaseReturn   PurchaseReturn @relation(fields: [purchaseReturnId], references: [id], onDelete: Cascade)

  @@map("purchase_return_items")
}

enum UserRole {
  ADMIN
  MANAGER
  CASHIER
}

enum PaymentMethod {
  CASH
  CARD
  QRIS
  DEBT
}

enum PaymentStatus {
  PAID
  PARTIAL
  UNPAID
}

enum PurchaseStatus {
  PENDING
  RECEIVED
  CANCELLED
}

enum TransactionStatus {
  PENDING
  COMPLETED
  VOID
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum RefundMethod {
  CASH
  TRANSFER
}

enum ReturnStatus {
  APPROVED
  COMPLETED
}

enum ItemCondition {
  NEW
  OPENED
  DAMAGED
}
